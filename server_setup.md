# Настройка сервера для запуска сайта
## Платформы и технологии
Пятая версия сайта написана на платформе Node.js, что, при желании, позволяет запускать его на любой операционной системе.

Данный документ подразумевает, что в продакшен среде используется ОС Debian Linux версии 8.

## Компоненты
Этапы настройки сервера представлены установкой и настройкой следующих компонент:

- Пользователь
- FTP
- База данных
- Web-сервер
- Node.js и npm
- Менеджер процессов
- Развертывание сайта
- Мониторинг

### Пользователь
Логином пользователя определим `psycho`. 
Для создания пользователя необходимо выполнить команды:

- `adduser psycho` — добавление пользователя в систему (появится несколько вопросов о данных пользователя и запрос на установку пароля);
- `apt-get install sudo` — установка sudo;
- `usermod -aG sudo psycho` — добавление нового пользователя в группу `sudo`;

Замечания:

1. Для применения настроек необходимо выйти из сессии пользователя `psycho` и снова зайти.
2. После создания пользователя настоятельно не рекомендуется использовать `root`.

### FTP
Используется vsftpd.

Установка сервера: `sudo apt-get install vsftpd`. После инсталляции сервер автоматически запустится и будет готов к работе.

После назначения домена и получения SSL-сертификата настоятельно рекомендуется активировать протокол SSL для FTP.

### База данных
Используется PostgreSQL.

Установка: `sudo apt-get install postgresql-9.4`.

После установки необходимо задать пользователю `postgres` пароль. Для этого запускаем `psql`:  `sudo -u postgres psql`.  
Далее, в psql: `alter user postgres password 'password';`.   
Для выхода из `psql` используется команда `\q`.

*Конфигурация сервера подразумевает, что на нём будет работать только psycho, подключаться к БД по сети будет нельзя и поэтому для работы можно использовать пользователя `postgres` с аутентификацией через `localhost`.*

Теперь необходимо создать БД сайта и восстановить данные из бэкапа (который должен быть предварительно загружен), для этого:

- запускаем `psql` (`psql -U postgres -h localhost`);
- создаём БД `psycho5`: `CREATE DATABASE psycho5;`;
- выходим из `psql`: `\q`;
- восстанавливаем БД из дампа: `pg_restore -F c -h localhost -d psycho5 -U postgres -cvO [файл с дампом БД]`.

*Для создания дампов можно использовать команду `pg_dump --file=[файл с дампом] -F c -U postgres -h localhost -Ccv psycho5`*


certbot renew --pre-hook "service nginx stop" --post-hook "service nginx start"
