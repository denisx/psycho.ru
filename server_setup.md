# Настройка сервера для запуска сайта
## Платформы и технологии
Пятая версия сайта написана на платформе Node.js, что, при желании, позволяет запускать его на любой операционной системе.

Данный документ подразумевает, что в продакшен среде используется ОС Debian Linux версии 8.

## Компоненты
Этапы настройки сервера представлены установкой и настройкой следующих компонент:

- [Пользователь](#user)
- [FTP](#ftp)
- [База данных](#db)
- [Node.js и npm](#node)
- [Менеджер процессов](#pm2)
- [Web-сервер](#nginx)
- Конфигурирование
- Мониторинг

### <a href='user'></a> Пользователь
Логином пользователя определим `psycho`. 
Для создания пользователя необходимо выполнить команды:

- `adduser psycho` — добавление пользователя в систему (появится несколько вопросов о данных пользователя и запрос на установку пароля);
- `apt-get install sudo` — установка sudo;
- `usermod -aG sudo psycho` — добавление нового пользователя в группу `sudo`;

Замечания:

1. Для применения настроек необходимо выйти из сессии пользователя `psycho` и снова зайти.
2. После создания пользователя настоятельно не рекомендуется использовать `root`.

### <a href='ftp'></a> FTP
Используется vsftpd.

Установка сервера: `sudo apt-get install vsftpd`. После инсталляции сервер автоматически запустится и будет готов к работе.

*После назначения домена и получения SSL-сертификата настоятельно рекомендуется активировать протокол SSL для FTP.*

### <a name='db'></a> База данных
Используется PostgreSQL.

Установка: `sudo apt-get install postgresql-9.4`.

После установки необходимо задать пользователю `postgres` пароль:

- `sudo -u postgres psql` — запуск psql;
- `alter user postgres password 'password';` — установка пароля;
- `\q` — выход.

*Конфигурация сервера подразумевает, что на нём будет работать только psycho, подключаться к БД по сети будет нельзя и поэтому для работы можно использовать пользователя `postgres` с аутентификацией через `localhost`.*

Теперь необходимо создать БД сайта и восстановить данные из бэкапа (который должен быть предварительно загружен), для этого:

- `psql -U postgres -h localhost` — запуск psql;
- `CREATE DATABASE psycho5;` — создаём БД `psycho5`;
- `\q`;
- `pg_restore -F c -h localhost -d psycho5 -U postgres -cvO [файл с дампом БД]` — восстановление БД из дампа.

*Для создания дампов можно использовать команду `pg_dump --file=[файл с дампом] -F c -U postgres -h localhost -Ccv psycho5`*

### <a href='node'></a> Node.js и npm
Для установки может потребоваться `curl`: `sudo apt-get install curl`.

Инструкцию по инсталляции можно найти [на сайте](https://nodejs.org) программы. [Актуальная версия](https://nodejs.org/en/download/package-manager/#debian-and-ubuntu-based-linux-distributions) на 30.01.17.

### <a href='pm2'></a> Менеджер процессов
Используется pm2.

`sudo npm i -g pm2`

### <a name="nginx"></a> Web–сервер
Используется nginx.

Инструкцию по установке можно найти [на сайте](https://nginx.org/ru) программы. [Актуальная версия](https://nginx.org/ru/linux_packages.html) на 30.01.17.

### Сайт
Прежде всего необходимо установить переменную окружения `NODE_ENV` в для Node.js.  
Для этого в файл `/etc/profile.d/nodejs.sh` необходимо добавить строки:  
```
NODE_ENV=production  
export NODE_ENV
```
После окончания редактирования нужно выйти из сессии и снова войти.

`apt-get install git`
`npm i pmenshih/psycho.ru`

certbot renew --pre-hook "service nginx stop" --post-hook "service nginx start"
